name: Test Proxies and Update Results

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'

jobs:
  update_and_test_proxies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install PyYAML and other dependencies
        run: |
          pip install PyYAML
          sudo apt-get update
          sudo apt-get install -y curl jq speedtest-cli yq coreutils

      - name: Fetch Gist, encode, and commit encoded_subscription.txt
        run: |
          GIST_URL="https://gist.githubusercontent.com/OpexDevelop/a676272468c9b6ac804092250ce9bc67/raw/opexvpn-high.txt"
          ENCODED_FILE="encoded_subscription.txt"

          echo "Fetching content from Gist: $GIST_URL"
          if ! curl -sL "$GIST_URL" -o original_sub_content.tmp; then
            echo "Failed to download from Gist."
            exit 1
          fi

          echo "Encoding Gist content to Base64..."
          base64 -w 0 original_sub_content.tmp > "$ENCODED_FILE"
          rm original_sub_content.tmp

          echo "Encoded content saved to $ENCODED_FILE"

          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          git add "$ENCODED_FILE"
          # Коммитим и пушим, только если файл изменился
          if ! git diff --staged --quiet; then
            git commit -m "Update encoded_subscription.txt from Gist"
            git push origin main # Пушим изменения в encoded_subscription.txt СРАЗУ
            echo "encoded_subscription.txt updated and pushed to repository."
          else
            echo "No changes to encoded_subscription.txt from Gist."
          fi

      - name: Download and prepare subconverter
        id: prepare_subconverter
        run: |
          SUBVERTER_VERSION="v0.9.0"
          echo "Downloading subconverter..."
          wget https://github.com/tindy2013/subconverter/releases/download/${SUBVERTER_VERSION}/subconverter_linux64.tar.gz
          
          echo "Removing any pre-existing 'subconverter' directory or file to ensure clean extraction..."
          rm -rf ./subconverter 
          
          echo "Extracting subconverter..."
          tar -xvf subconverter_linux64.tar.gz
          
          ACTUAL_SUBCONVERTER_BINARY="./subconverter/subconverter" 
          
          if [ ! -f "$ACTUAL_SUBCONVERTER_BINARY" ]; then
            echo "Subconverter binary not found at $ACTUAL_SUBCONVERTER_BINARY after extraction."
            ls -lahR . 
            exit 1
          fi
          
          chmod +x "$ACTUAL_SUBCONVERTER_BINARY"
          
          cat <<EOF > pref.ini
          [server]
          listen = 127.0.0.1
          port = 25500
          [common]
          clash_rule_base=
          surge_rule_base=
          surfboard_rule_base=
          mellow_rule_base=
          loon_rule_base=
          sssub_rule_base=
          default_external_config=
          EOF
          echo "pref.ini created."
          echo "subconverter_binary_path=$ACTUAL_SUBCONVERTER_BINARY" >> $GITHUB_OUTPUT
          echo "Subconverter preparation step completed."

      - name: Start and health check subconverter
        run: |
          ACTUAL_SUBCONVERTER_BINARY="${{ steps.prepare_subconverter.outputs.subconverter_binary_path }}"
          echo "Starting subconverter ($ACTUAL_SUBCONVERTER_BINARY) in background..."
          nohup "$ACTUAL_SUBCONVERTER_BINARY" > subconverter.log 2>&1 &
          SUBCONVERTER_PID=$!
          echo "Subconverter PID: $SUBCONVERTER_PID"
          
          sleep 8 
          if ! ps -p $SUBCONVERTER_PID > /dev/null; then
            echo "Subconverter process $SUBCONVERTER_PID is not running!"
            cat subconverter.log
            exit 1
          else
            echo "Subconverter is running (PID: $SUBCONVERTER_PID)."
          fi

          echo "Attempting health check..."
          if curl --connect-timeout 5 -sfS "http://127.0.0.1:25500/sub" > /dev/null; then
            echo "Health check: Unexpected HTTP success (2xx) from /sub (server is up)."
          elif [ $? -eq 22 ]; then 
            echo "Health check successful (expected HTTP error from /sub, server is up)."
          else
            CURL_EXIT_CODE=$?
            echo "Health check failed. Curl exit code: $CURL_EXIT_CODE"
            cat subconverter.log
            ss -tulnp || sudo ss -tulnp 
            exit 1
          fi

      - name: Download and install Sing-box
        run: |
          SINGBOX_VERSION="1.11.10"
          wget https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz
          tar -xzf sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz
          sudo mv sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box /usr/local/bin/sing-box
          sudo chmod +x /usr/local/bin/sing-box
          sing-box version

      - name: Ensure Python script is executable
        run: chmod +x scripts/generate_singbox_config.py

      - name: Fetch GIST URL with subconverter, and process nodes
        id: process_nodes
        run: |
          # ИСПОЛЬЗУЕМ ПРЯМУЮ ССЫЛКУ НА GIST ДЛЯ SUBCONVERTER
          SUBSCRIPTION_URL_RAW="https://gist.githubusercontent.com/OpexDevelop/a676272468c9b6ac804092250ce9bc67/raw/opexvpn-high.txt"
          SUBSCRIPTION_URL_ENCODED=$(echo -n "$SUBSCRIPTION_URL_RAW" | jq -sRr @uri)
          
          echo "Fetching and converting GIST URL to Clash format: http://127.0.0.1:25500/sub?target=clash&url=${SUBSCRIPTION_URL_ENCODED}"
          if ! curl --fail -sL "http://127.0.0.1:25500/sub?target=clash&url=${SUBSCRIPTION_URL_ENCODED}" -o sub_clash_config.yaml; then
            CURL_EXIT_CODE_SUB=$?
            echo "Curl command failed to get subscription from subconverter. Exit code: $CURL_EXIT_CODE_SUB"
            cat subconverter.log 
            exit 1
          fi
          
          if [ ! -s sub_clash_config.yaml ] || ! grep -q "proxies:" sub_clash_config.yaml; then
            echo "Failed to convert GIST or it is empty/invalid (no 'proxies:' section)."
            echo "--- sub_clash_config.yaml content (first 20 lines) ---"
            head -n 20 sub_clash_config.yaml 
            echo "--- Subconverter Log (subconverter.log) ---"
            cat subconverter.log 
            exit 1
          fi
          echo "GIST URL content converted to sub_clash_config.yaml"

          RESULTS_JSON_ARRAY="[]"
          
          PROXY_COUNT=$(yq '.proxies | length' sub_clash_config.yaml)
          if [ -z "$PROXY_COUNT" ] || [ "$PROXY_COUNT" -eq 0 ]; then
            echo "No proxies found in the converted Clash config from GIST URL."
            cat sub_clash_config.yaml
            pkill subconverter || echo "Subconverter not running."
            exit 0
          fi
          echo "Found $PROXY_COUNT proxies to test from GIST URL."

          for i in $(seq 0 $((PROXY_COUNT - 1))); do
            CLASH_NODE_JSON=$(yq ".proxies[$i]" -o=json sub_clash_config.yaml)

            if [ -z "$CLASH_NODE_JSON" ] || [ "$CLASH_NODE_JSON" == "null" ]; then
                echo "Failed to extract proxy node $i. Skipping."
                continue
            fi
            
            NODE_NAME_RAW=$(echo "$CLASH_NODE_JSON" | jq -r .name)
            NODE_ID_SUFFIX=$(echo "$NODE_NAME_RAW" | sed 's/[^a-zA-Z0-9_-]/_/g')"_${i}"
            NODE_ID="node_${NODE_ID_SUFFIX}"

            echo "Processing Node $((i + 1))/$PROXY_COUNT: $NODE_NAME_RAW (ID: $NODE_ID)"
            TEMP_SINGBOX_CONFIG="temp_singbox_config_${NODE_ID}.json"

            echo "$CLASH_NODE_JSON" | python3 scripts/generate_singbox_config.py "$NODE_ID" > "$TEMP_SINGBOX_CONFIG"

            if ! grep -q '"type":' "$TEMP_SINGBOX_CONFIG"; then
                echo "Failed to generate sing-box config for node $NODE_NAME_RAW. Skipping."
                cat "$TEMP_SINGBOX_CONFIG"
                CURRENT_NODE_JSON=$(jq -n --arg name "$NODE_NAME_RAW" --arg error "Config generation failed" '{name: $name, status: "error", error: $error, timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))}')
                RESULTS_JSON_ARRAY=$(echo "$RESULTS_JSON_ARRAY" | jq --argjson item "$CURRENT_NODE_JSON" '. + [$item]')
                rm -f "$TEMP_SINGBOX_CONFIG"
                continue
            fi

            echo "Starting Sing-box for $NODE_ID..."
            sing-box run -c "$TEMP_SINGBOX_CONFIG" &
            SINGBOX_PID=$!
            sleep 8

            if ! ps -p $SINGBOX_PID > /dev/null; then
                echo "Sing-box failed to start for $NODE_ID. PID: $SINGBOX_PID"
                CURRENT_NODE_JSON=$(jq -n --arg name "$NODE_NAME_RAW" --arg error "Sing-box failed to start" '{name: $name, status: "error", error: $error, timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))}')
                RESULTS_JSON_ARRAY=$(echo "$RESULTS_JSON_ARRAY" | jq --argjson item "$CURRENT_NODE_JSON" '. + [$item]')
                rm -f "$TEMP_SINGBOX_CONFIG"
                continue
            fi
            echo "Sing-box started with PID $SINGBOX_PID for $NODE_ID."

            PROXY_ADDRESS="socks5h://127.0.0.1:10808"

            echo "Testing IP for $NODE_ID..."
            IP_INFO_RAW=$(curl -s --connect-timeout 10 --max-time 15 --proxy "$PROXY_ADDRESS" "https://ip.oxylabs.io/location")
            
            IP_ADDRESS=$(echo "$IP_INFO_RAW" | jq -r '.ip // "N/A"')
            COUNTRY=$(echo "$IP_INFO_RAW" | jq -r '.providers.dbip.country // .providers.ip2location.country // .providers.ipinfo.country // .providers.maxmind.country // "N/A"')
            CITY=$(echo "$IP_INFO_RAW" | jq -r '.providers.dbip.city // .providers.ip2location.city // .providers.ipinfo.city // .providers.maxmind.city // "N/A"')
            ASN_ORG=$(echo "$IP_INFO_RAW" | jq -r '.providers.dbip.org_name // .providers.ip2location.org_name // .providers.ipinfo.org_name // .providers.maxmind.org_name // "N/A"')
            ASN_NUMBER=$(echo "$IP_INFO_RAW" | jq -r '.providers.dbip.asn // .providers.ip2location.asn // .providers.ipinfo.asn // .providers.maxmind.asn // "N/A"')

            echo "Running speedtest for $NODE_ID..."
            SPEEDTEST_RESULT_RAW=$(speedtest-cli --proxy "$PROXY_ADDRESS" --simple --timeout 35) || SPEEDTEST_RESULT_RAW="Ping: N/A ms Download: N/A Mbit/s Upload: N/A Mbit/s"

            PING=$(echo "$SPEEDTEST_RESULT_RAW" | grep -oP 'Ping: \K[0-9.]+(?= ms)' || echo "N/A")
            DOWNLOAD_SPEED=$(echo "$SPEEDTEST_RESULT_RAW" | grep -oP 'Download: \K[0-9.]+(?= Mbit/s)' || echo "N/A")
            UPLOAD_SPEED=$(echo "$SPEEDTEST_RESULT_RAW" | grep -oP 'Upload: \K[0-9.]+(?= Mbit/s)' || echo "N/A")

            kill -SIGTERM $SINGBOX_PID || echo "Failed to send SIGTERM to Sing-box"
            wait $SINGBOX_PID 2>/dev/null
            echo "Sing-box stopped for $NODE_ID."

            CURRENT_NODE_JSON=$(jq -n \
              --arg name "$NODE_NAME_RAW" \
              --arg ip "$IP_ADDRESS" \
              --arg country "$COUNTRY" \
              --arg city "$CITY" \
              --arg asn_org "$ASN_ORG" \
              --arg asn_number "$ASN_NUMBER" \
              --arg ping "$PING" \
              --arg download "$DOWNLOAD_SPEED" \
              --arg upload "$UPLOAD_SPEED" \
              '{name: $name, ip_address: $ip, country_code: $country, city: $city, asn_organization: $asn_org, asn_number: $asn_number, ping_ms: $ping, download_mbps: $download, upload_mbps: $upload, status: "tested", timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))}')
            
            RESULTS_JSON_ARRAY=$(echo "$RESULTS_JSON_ARRAY" | jq --argjson item "$CURRENT_NODE_JSON" '. + [$item]')
            rm -f "$TEMP_SINGBOX_CONFIG"
            echo "------------------------------------"
          done

          echo "$RESULTS_JSON_ARRAY" > proxy_results.json
          echo "All nodes processed. Results saved to proxy_results.json"

          pkill subconverter || echo "Subconverter not running or already stopped."

      - name: Commit results
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          # Добавляем proxy_results.json. encoded_subscription.txt уже должен быть закоммичен ранее, если изменился.
          git add proxy_results.json 
          if ! git diff --staged --quiet; then
            git commit -m "Update proxy test results ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))"
            git push
          else
            echo "No changes to proxy results."
          fi